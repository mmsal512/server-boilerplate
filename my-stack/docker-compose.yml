version: '3.8'

networks:
  web-public:
    external: true
  n8n-backend:
    driver: bridge
  evo-backend:
    driver: bridge
  odoo-backend:
    driver: bridge

services:

  # ===== TRAEFIK =====
  traefik:
    image: "traefik:latest"
    container_name: traefik_gateway
    restart: always
    command:
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--accesslog=true"
      - "--accesslog.format=json"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
      - "--certificatesresolvers.mytlschallenge.acme.email=${SSL_EMAIL}"
      - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"
      - "--entrypoints.web.forwardedHeaders.trustedIPs=173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,104.16.0.0/13,104.24.0.0/14,172.64.0.0/13,131.0.72.0/22"
      - "--entrypoints.websecure.forwardedHeaders.trustedIPs=173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,104.16.0.0/13,104.24.0.0/14,172.64.0.0/13,131.0.72.0/22"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - traefik_letsencrypt:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
    logging: &logging-config
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - web-public
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M

  # ===== PORTAINER =====
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    logging: *logging-config
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web-public"
      - "traefik.http.routers.portainer.rule=Host(`portainer.${DOMAIN_NAME}`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=mytlschallenge"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
    networks:
      - web-public
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 64M

  # ===== GLANCES =====
  glances:
    image: nicolargo/glances:latest
    container_name: glances
    restart: always
    pid: host
    environment:
      - GLANCES_OPT=-w --bind 0.0.0.0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    logging: *logging-config
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web-public"
      - "traefik.http.routers.glances.rule=Host(`monitor.${DOMAIN_NAME}`)"
      - "traefik.http.routers.glances.entrypoints=websecure"
      - "traefik.http.routers.glances.tls.certresolver=mytlschallenge"
      - "traefik.http.services.glances.loadbalancer.server.port=61208"
    networks:
      - web-public
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 128M

  # ===== N8N =====
  n8n:
    image: docker.n8n.io/n8nio/n8n
    container_name: n8n-app
    restart: always
    environment:
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_HOST=${DOMAIN_NAME}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - N8N_RUNNERS_ENABLED=true
      - NODE_ENV=production
      - WEBHOOK_URL=https://${DOMAIN_NAME}/
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - N8N_PROXY_HOPS=1
      - N8N_EXECUTIONS_PROCESS=${N8N_EXECUTIONS_PROCESS}
      - N8N_PUSH_BACKEND=${N8N_PUSH_BACKEND}
      - DB_REDIS_HOST=redis-n8n
      - DB_REDIS_PORT=6379
      - N8N_DEFAULT_BINARY_DATA_MODE=filesystem
      - N8N_EXECUTIONS_DATA_PRUNE=true
      - N8N_EXECUTIONS_DATA_MAX_AGE=168
      - N8N_EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - N8N_EXECUTIONS_DATA_SAVE_ON_SUCCESS=none
    volumes:
      - n8n_data:/home/node/.n8n
      - n8n_files:/files
    logging: *logging-config
    networks:
      - web-public
      - n8n-backend
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web-public"
      - "traefik.http.routers.n8n.rule=Host(`${DOMAIN_NAME}`)"
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=mytlschallenge"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1.2G
        reservations:
          memory: 512M

  redis-n8n:
    image: redis:alpine
    container_name: redis-n8n
    restart: always
    command: redis-server --maxmemory 200mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_n8n_data:/data
    logging: *logging-config
    networks:
      - n8n-backend
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
        reservations:
          memory: 64M

  # ===== EVOLUTION API =====
  evo-app:
    image: evoapicloud/evolution-api:latest
    container_name: evo-app
    restart: always
    env_file:
      - .env.evolution
    volumes:
      - evolution_instances:/evolution/instances
    logging: *logging-config
    networks:
      - web-public
      - evo-backend
    depends_on:
      db-evolution:
        condition: service_healthy
      redis-evolution:
        condition: service_started
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web-public"
      - "traefik.http.routers.evo.rule=Host(`evo.${DOMAIN_NAME}`)"
      - "traefik.http.routers.evo.tls=true"
      - "traefik.http.routers.evo.entrypoints=websecure"
      - "traefik.http.routers.evo.tls.certresolver=mytlschallenge"
      - "traefik.http.services.evo.loadbalancer.server.port=8080"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M

  db-evolution:
    image: postgres:15
    container_name: db-evolution
    restart: always
    environment:
      POSTGRES_DB: evolution
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${EVOLUTION_DB_PASSWORD}
    volumes:
      - evolution_pg_data:/var/lib/postgresql/data
    logging: *logging-config
    networks:
      - evo-backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d evolution"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M

  redis-evolution:
    image: redis:7-alpine
    container_name: redis-evolution
    restart: always
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_evolution_data:/data
    networks:
      - evo-backend
    logging: *logging-config
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
        reservations:
          memory: 64M

  # ===== ODOO =====
  db-odoo:
    image: postgres:15
    container_name: db-odoo
    restart: always
    environment:
      - POSTGRES_USER=odoo
      - POSTGRES_PASSWORD=${ODOO_DB_PASSWORD}
      - POSTGRES_DB=postgres
    volumes:
      - odoo_pg_data:/var/lib/postgresql/data
      - ./postgres-config/postgresql.conf:/etc/postgresql/postgresql.conf
    command: ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]
    networks:
      - odoo-backend
    logging: *logging-config
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1.5G
        reservations:
          memory: 1G

  odoo-app:
    image: odoo:16.0
    container_name: odoo-app
    restart: always
    depends_on:
      - db-odoo
      - redis-cache-odoo
    environment:
      - HOST=db-odoo
      - USER=odoo
      - PASSWORD=${ODOO_DB_PASSWORD}
    volumes:
      - odoo_web_data:/var/lib/odoo
      - ./odoo-config/odoo.conf:/etc/odoo/odoo.conf
    networks:
      - web-public
      - odoo-backend
    logging: *logging-config
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web-public"
      - "traefik.http.routers.odoo-main.rule=Host(`odoo.${DOMAIN_NAME}`)"
      - "traefik.http.routers.odoo-main.entrypoints=websecure"
      - "traefik.http.routers.odoo-main.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.odoo-main.service=odoo-main-service"
      - "traefik.http.services.odoo-main-service.loadbalancer.server.port=8069"
      - "traefik.http.routers.odoo-chat.rule=Host(`odoo.${DOMAIN_NAME}`) && PathPrefix(`/longpolling`)"
      - "traefik.http.routers.odoo-chat.entrypoints=websecure"
      - "traefik.http.routers.odoo-chat.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.odoo-chat.service=odoo-chat-service"
      - "traefik.http.services.odoo-chat-service.loadbalancer.server.port=8072"
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2.5G
        reservations:
          memory: 1G

  # ===== NEXTJS =====
  nextjs-app:
    image: ${NEXTJS_IMAGE:-mohammed512/odoo-nextjs-frontend:latest}
    container_name: nextjs-app
    restart: always
    environment:
      - REDIS_CACHE_HOST=redis-cache-odoo
      - REDIS_CACHE_PORT=6379
    networks:
      - web-public
      - odoo-backend
    logging: *logging-config
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web-public"
      - "traefik.http.routers.nextjs.rule=Host(`next.${DOMAIN_NAME}`)"
      - "traefik.http.routers.nextjs.entrypoints=websecure"
      - "traefik.http.routers.nextjs.tls.certresolver=mytlschallenge"
      - "traefik.http.services.nextjs.loadbalancer.server.port=3000"
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 1G
        reservations:
          memory: 256M

  redis-cache-odoo:
    image: redis:alpine
    container_name: redis-cache-odoo
    restart: always
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_odoo_cache_data:/data
    networks:
      - odoo-backend
    logging: *logging-config
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
        reservations:
          memory: 64M

volumes:
  traefik_letsencrypt:
  portainer_data:
  n8n_data:
  n8n_files:
  redis_n8n_data:
  evolution_instances:
  evolution_pg_data:
  redis_evolution_data:
  odoo_pg_data:
  odoo_web_data:
  redis_odoo_cache_data:
